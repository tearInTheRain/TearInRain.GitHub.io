---
title: Java虚拟机规范
date: 2024-11-7 21:20:00 +0800
categories: [编程, Java]
tags: [虚拟机规范] 
description: Java
---

## 介绍

- Java 最初为开发互联网软件设计。所以需要程序能在网络中传输,并兼容,安全的在任何平台上运行  
- Java虚拟机是一种抽象的计算机概念,和类文件交互,并进行语法和结构约束以保证安全。  

## 虚拟机结构

- class文件格式
- 数据类型。包括基本类型和引用类型,基本类型通过操作指令来区分。如iadd
  - 基本类型包括数字类型,布尔类型,返回地址类型(指向Java指令操作码的指针)
    - 布尔类型使用int,布尔数组使用字节数组  
  - 引用类型包括class,array,interface
- 运行时数据区域
  - pc寄存器:线程独立,保存当前在执行的指令地址
  - 虚拟机栈:线程独立。参与方法调用和返回。栈操作仅限于压栈和出栈,在分配方式上更加灵活
    - 帧:空间编译期间计算,在方法调用时分配,结束时回收。
      - 局部变量数组:一个局部变量保存32位。类方法从下标0开始,实例方法的下标0用于保存实例引用
      - 操作数栈:保存计算用到的局部变量和常量,方法参数和返回值
      - 动态链接:指向当前方法运行时常量池引用,用于动态链接。动态链接将对方法,变量的符号引用转为具体的地址。
  - 堆:线程共享。保存类实例和数组,通过垃圾收集回收内存,不要求连续。
  - 方法区:线程共享。储存类结构。如运行时常量池,字段,方法代码。
    - 运行时常量池:类似于符号表
  - 本地方法栈:传统的栈用于支持本地方法
- 对象结构:不要求对象有特定的内部结构  
- 特殊方法
  - 实例初始化方法:对应Java中构造器,名字为< init > 并且返回void类型。
    - 声明约束:access_flag和代码数组受到限制
    - 使用约束:只能由未出初始化的类实例上的invokeSpecial指令调用
  - 类初始化方法:一个类或接口最多只有一个类初始化方法,名字为< cinit >,有ACC_STATIC标识,
  - 签名多态方法:在VarHandle类中,有Object[]类型的参数, ACC_VARARGS and ACC_NATIVE的标识
    - 对签名多态方法特殊处理以实现方法句柄的调用。方法句柄是对方法,变量的强引用,并支持操作
- 异常:是Throwable或子类的实例。当抛出异常时,会导致从当前节点的控制转移,异常可能同步在一个执行执行后或异步发生
  - 同步异常
    - athrow指令执行
    - 检测到异常执行情况:指令违法Java语义操作；加载或链接程序发生错误(动态加载类)
  - 异步异常:Java虚拟机内部错误,如内存不足,硬件错误
  - 每个方法有0个或多个异常处理器保存在class文件的表中,每个异常处理器有作用区域,处理异常的类型和处理异常的代码。如果当前方法没有处理该异常的处理器,则会弹出帧,恢复上一个方法,递归查找。如果当前栈没有处理该异常的处理器,则当前线程会立刻终止。在终止前,按当前线程uncaughtException,线程组uncaughtException,默认异常处理器的方法优先级来处理该异常。
- 指令集:每个指令集都由操作码和操作数组成。
  - 操作码:8字节,最多256类,所以并非每种操作都支持所有类型,可以将不支持的类型用专门指令转成支持的类型后操作。
    - 比如大多数指令不支持 byte,short。当这些指令被加载到操作数栈时,会通过零拓展为int类型。
    - 方法级同步是隐性执行的,在运行时常量池的method_info结构中通过ACC_SYNCHRONIZED标志来区分。有该标志的方法执行时,线程进入监视器,在持有监视器期间,其他线程无法执行该方法。
    - 指令序列的同步,monitorenter和monitorexit指令